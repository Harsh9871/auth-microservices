{
  "project": "Auth Microservice API",
  "version": "1.0.0",
  "baseUrl": "https://notebooks-objectives-throat-survey.trycloudflare.com/",
  "description": "A multi-tenant authentication microservice with JWT tokens, refresh tokens, and admin management",
  "database": "PostgreSQL with Prisma ORM",
  "features": [
    "Multi-tenant architecture (app_id based isolation)",
    "JWT access & refresh tokens",
    "Role-based access control (user/admin)",
    "Token validation endpoint for external services",
    "Admin user management with pagination",
    "Rate limiting ready",
    "CORS enabled"
  ],
  "authentication": {
    "type": "Bearer Token (JWT)",
    "tokenFormat": "Authorization: Bearer <access_token>",
    "tokenLifetime": "1 hour",
    "refreshTokenLifetime": "7 days"
  },
  "serverConfiguration": {
    "cors": {
      "origin": "*",
      "methods": "*",
      "allowedHeaders": "*",
      "credentials": true
    },
    "port": "process.env.PORT || 4000",
    "bodyParser": "express.json() enabled"
  },
  "endpoints": {
    "health": {
      "method": "GET",
      "path": "/",
      "description": "Health check endpoint",
      "authentication": false,
      "request": {},
      "successResponse": {
        "status": 200,
        "body": "ðŸš€ Prisma Auth Microservice running successfully!"
      }
    },
    "register": {
      "method": "POST",
      "path": "/api/auth/register",
      "description": "Register a new user",
      "authentication": false,
      "request": {
        "body": {
          "name": "string (required, min 2 chars)",
          "email": "string (required, valid email)",
          "password": "string (required, min 3 chars)",
          "app_id": "string (required, existing app ID)",
          "role": "string (optional, 'user' or 'admin', defaults to 'user')"
        }
      },
      "successResponse": {
        "status": 201,
        "body": {
          "success": true,
          "message": "User registered successfully",
          "user": {
            "id": "uuid",
            "name": "string",
            "email": "string",
            "app_id": "string",
            "role": "string",
            "createdAt": "ISO date string"
          }
        }
      },
      "errorResponses": [
        {
          "status": 400,
          "body": {
            "success": false,
            "message": "Error description"
          }
        }
      ]
    },
    "login": {
      "method": "POST",
      "path": "/api/auth/login",
      "description": "Authenticate user and get tokens",
      "authentication": false,
      "request": {
        "body": {
          "email": "string (required)",
          "password": "string (required)",
          "app_id": "string (required)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "Login successful",
          "accessToken": "jwt_token",
          "refreshToken": "jwt_token",
          "user": {
            "id": "uuid",
            "name": "string",
            "email": "string",
            "app_id": "string",
            "role": "string"
          }
        }
      },
      "errorResponses": [
        {
          "status": 401,
          "body": {
            "success": false,
            "message": "Invalid credentials"
          }
        }
      ]
    },
    "getProfile": {
      "method": "GET",
      "path": "/api/auth/me",
      "description": "Get current user profile",
      "authentication": true,
      "request": {
        "headers": {
          "Authorization": "Bearer <access_token>"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "user": {
            "id": "uuid",
            "name": "string",
            "email": "string",
            "app_id": "string",
            "role": "string",
            "createdAt": "ISO date string"
          }
        }
      },
      "errorResponses": [
        {
          "status": 401,
          "body": {
            "success": false,
            "message": "Invalid or expired token"
          }
        }
      ]
    },
    "validateToken": {
      "method": "POST",
      "path": "/api/auth/validate-token",
      "description": "Validate any JWT token (for external services)",
      "authentication": false,
      "request": {
        "body": {
          "token": "string (required, JWT token)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "Token is valid",
          "user": {
            "id": "uuid",
            "name": "string",
            "email": "string",
            "app_id": "string",
            "role": "string"
          }
        }
      },
      "errorResponses": [
        {
          "status": 401,
          "body": {
            "success": false,
            "message": "Invalid or expired token"
          }
        }
      ]
    },
    "refreshToken": {
      "method": "POST",
      "path": "/api/auth/refresh-token",
      "description": "Get new access token using refresh token",
      "authentication": false,
      "request": {
        "body": {
          "refreshToken": "string (required)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "Token refreshed successfully",
          "accessToken": "jwt_token"
        }
      },
      "errorResponses": [
        {
          "status": 401,
          "body": {
            "success": false,
            "message": "Invalid refresh token"
          }
        }
      ]
    },
    "logout": {
      "method": "POST",
      "path": "/api/auth/logout",
      "description": "Invalidate refresh token",
      "authentication": false,
      "request": {
        "body": {
          "refreshToken": "string (required)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "Logged out successfully"
        }
      }
    },
    "getAllUsers": {
      "method": "GET",
      "path": "/api/users",
      "description": "Get paginated list of users in same app (Admin only)",
      "authentication": true,
      "requiredRole": "admin",
      "request": {
        "headers": {
          "Authorization": "Bearer <access_token>"
        },
        "query": {
          "page": "integer (optional, default: 1)",
          "limit": "integer (optional, default: 10, max: 100)",
          "search": "string (optional, search in name/email)",
          "sortBy": "string (optional, name/email/role/createdAt/updatedAt)",
          "sortOrder": "string (optional, asc/desc)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "Users retrieved successfully",
          "data": {
            "users": [
              {
                "id": "uuid",
                "name": "string",
                "email": "string",
                "role": "string",
                "app_id": "string",
                "createdAt": "ISO date string",
                "updatedAt": "ISO date string"
              }
            ],
            "pagination": {
              "currentPage": 1,
              "totalPages": 1,
              "totalUsers": 10,
              "usersPerPage": 10,
              "hasNextPage": false,
              "hasPrevPage": false,
              "nextPage": null,
              "prevPage": null
            }
          }
        }
      },
      "errorResponses": [
        {
          "status": 403,
          "body": {
            "success": false,
            "message": "Admin access required"
          }
        }
      ]
    },
    "deleteUser": {
      "method": "DELETE",
      "path": "/api/users/:id",
      "description": "Delete user from same app (Admin only)",
      "authentication": true,
      "requiredRole": "admin",
      "request": {
        "headers": {
          "Authorization": "Bearer <access_token>"
        },
        "params": {
          "id": "uuid (user ID to delete)"
        }
      },
      "successResponse": {
        "status": 200,
        "body": {
          "success": true,
          "message": "User deleted successfully",
          "deletedUser": {
            "id": "uuid",
            "email": "string"
          }
        }
      },
      "errorResponses": [
        {
          "status": 403,
          "body": {
            "success": false,
            "message": "Admin access required"
          }
        },
        {
          "status": 400,
          "body": {
            "success": false,
            "message": "Cannot delete your own account"
          }
        }
      ]
    }
  },
  "fileStructure": {
    "server.js": {
      "description": "Main server file with Express setup and middleware",
      "features": [
        "CORS configuration with wildcard origins",
        "JSON body parsing",
        "Route mounting for /api/auth and /api/users",
        "Environment variable configuration"
      ]
    },
    "controllers/user.controller.js": {
      "description": "User management controller for admin operations",
      "methods": {
        "getAllUsers": {
          "parameters": [
            "app_id from middleware",
            "page",
            "limit",
            "search from query"
          ],
          "functionality": "Handles paginated user retrieval with search"
        },
        "deleteUser": {
          "parameters": [
            "user id from params",
            "adminAppId from middleware",
            "adminUserId from token"
          ],
          "functionality": "Handles user deletion with safety checks"
        }
      }
    },
    "middleware/admin.middleware.js": {
      "description": "Authentication and authorization middleware for admin routes",
      "middlewares": {
        "adminOnly": {
          "function": "Verifies JWT token and checks if user has admin role",
          "checks": ["Bearer token presence", "Token validity", "Admin role"]
        },
        "sameAppOnly": {
          "function": "Ensures operations are scoped to user's app_id",
          "checks": [
            "Extracts app_id from token",
            "Sets req.userAppId for service layer"
          ]
        }
      }
    },
    "routes/user.router.js": {
      "description": "User management routes with admin protection",
      "routes": {
        "GET /": "Get all users (protected by adminOnly + sameAppOnly)",
        "DELETE /:id": "Delete user (protected by adminOnly + sameAppOnly)"
      },
      "middleware": "adminOnly and sameAppOnly applied to all routes"
    },
    "services/user.service.js": {
      "description": "Business logic for user management operations",
      "methods": {
        "getAllUsers": {
          "parameters": ["app_id", "page", "limit", "search"],
          "features": [
            "Pagination with validation (max 100 per page)",
            "Search across name and email fields",
            "Total count and pagination metadata",
            "Case-insensitive search"
          ]
        },
        "deleteUser": {
          "parameters": ["userId", "adminAppId"],
          "features": [
            "Cross-app deletion prevention",
            "User existence validation",
            "Cascading deletion (handled by Prisma relations)"
          ]
        }
      }
    }
  },
  "databaseSchema": {
    "tables": {
      "User": {
        "columns": {
          "id": "UUID (Primary Key)",
          "name": "VARCHAR",
          "email": "VARCHAR (Unique with app_id)",
          "password": "VARCHAR (Hashed)",
          "role": "ENUM('user', 'admin')",
          "app_id": "VARCHAR (Foreign Key to App)",
          "createdAt": "TIMESTAMP",
          "updatedAt": "TIMESTAMP"
        },
        "indexes": [
          "email + app_id (Composite Unique)",
          "app_id + createdAt (Pagination)",
          "app_id + name (Search)",
          "app_id + email (Search)"
        ]
      },
      "App": {
        "columns": {
          "id": "UUID (Primary Key)",
          "name": "VARCHAR",
          "app_id": "VARCHAR (Unique)",
          "client_id": "VARCHAR (Unique)",
          "client_secret": "VARCHAR",
          "plan": "ENUM('free', 'premium')",
          "isActive": "BOOLEAN",
          "createdAt": "TIMESTAMP",
          "updatedAt": "TIMESTAMP"
        }
      },
      "RefreshToken": {
        "columns": {
          "id": "UUID (Primary Key)",
          "token": "VARCHAR (Unique)",
          "expiresAt": "TIMESTAMP",
          "userId": "UUID (Foreign Key to User)",
          "createdAt": "TIMESTAMP"
        }
      }
    }
  },
  "environmentVariables": {
    "PORT": "Server port (default: 4000)",
    "DATABASE_URL": "PostgreSQL connection string",
    "JWT_SECRET": "Secret key for JWT tokens"
  },
  "errorHandling": {
    "commonErrors": [
      {
        "status": 400,
        "scenarios": [
          "Missing required fields",
          "Invalid email format",
          "Duplicate email"
        ]
      },
      {
        "status": 401,
        "scenarios": ["Invalid token", "Expired token", "No token provided"]
      },
      {
        "status": 403,
        "scenarios": ["Admin access required", "Cross-app access attempted"]
      },
      {
        "status": 404,
        "scenarios": ["User not found", "App not found"]
      },
      {
        "status": 500,
        "scenarios": ["Database error", "Server error"]
      }
    ]
  },
  "securityFeatures": {
    "passwordHashing": "bcrypt",
    "tokenSecurity": "JWT with HS256 algorithm",
    "dataIsolation": "app_id based multi-tenancy",
    "inputValidation": "express-validator ready",
    "rateLimiting": "express-rate-limit ready",
    "cors": "Configured with wildcard (adjust for production)"
  },
  "testingExamples": {
    "quickStart": [
      "1. Register user: POST /api/auth/register",
      "2. Login: POST /api/auth/login",
      "3. Get profile: GET /api/auth/me",
      "4. Validate token: POST /api/auth/validate-token"
    ],
    "adminWorkflow": [
      "1. Register admin: POST /api/auth/register with role: 'admin'",
      "2. Login as admin",
      "3. List users: GET /api/users?page=1&limit=10",
      "4. Delete user: DELETE /api/users/:id"
    ],
    "paginationExamples": [
      "GET /api/users?page=1&limit=10",
      "GET /api/users?page=2&limit=20&search=admin",
      "GET /api/users?page=1&limit=50&sortBy=name&sortOrder=asc"
    ]
  },
  "deployment": {
    "productionReady": true,
    "recommendations": [
      "Use environment variables for secrets",
      "Restrict CORS origins in production (replace '*')",
      "Add rate limiting in production",
      "Use Redis for distributed rate limiting",
      "Add logging and monitoring",
      "Use HTTPS in production",
      "Set up database connection pooling"
    ],
    "securityNotes": [
      "Change CORS origin from '*' to specific domains in production",
      "Use strong JWT secrets",
      "Enable HTTPS",
      "Implement rate limiting"
    ]
  },
  "apiUsageExamples": {
    "getAllUsersCurl": "curl -X GET \"https://notebooks-objectives-throat-survey.trycloudflare.com/api/users?page=1&limit=10\" -H \"Authorization: Bearer <admin_token>\"",
    "deleteUserCurl": "curl -X DELETE \"https://notebooks-objectives-throat-survey.trycloudflare.com/api/users/<user_id>\" -H \"Authorization: Bearer <admin_token>\"",
    "searchUsersCurl": "curl -X GET \"https://notebooks-objectives-throat-survey.trycloudflare.com/api/users?page=1&limit=10&search=admin\" -H \"Authorization: Bearer <admin_token>\""
  },
  "notes": {
    "multiTenancy": "Each user belongs to an app_id. All operations are scoped to the user's app_id.",
    "tokenValidation": "External services can use /api/auth/validate-token to validate user tokens.",
    "scalability": "Designed to handle millions of users with proper pagination and indexing.",
    "adminRoutes": "All /api/users routes require admin role and are scoped to the same app_id."
  }
}
